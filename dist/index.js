(()=>{"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}var r=function(){function e(n){t(this,e),this.image=n}return n(e,[{key:"putPixel",value:function(t,e,n,r,i,o){var a=Math.round(t),s=Math.round(e);if(!(a<0||a>this.image.width||s<0||s>this.image.height)){var c=s*(4*this.image.width)+4*a;this.image.data[c]=n,this.image.data[c+1]=r,this.image.data[c+2]=i,this.image.data[c+3]=o}}},{key:"drawLine",value:function(t,e,n,r,i,o,a,s){var c=Math.abs(t-n)<Math.abs(e-r),u=c?e:t,l=c?t:e,h=c?r:n,f=c?n:r;if(u>h){var y=u;u=h,h=y,y=l,l=f,f=y}for(var v=h-u,d=f-l,p=2*Math.abs(d),m=0,g=l,x=u;x<=h;x+=1)this.putPixel(c?g:x,c?x:g,i,o,a,s),(m+=p)>v&&(g+=f>l?1:-1,m-=2*v)}}]),e}(),i=function(){function e(n){if(t(this,e),!(n instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");this.elem=n,this.context2d=n.getContext("2d"),this.width=n.width,this.height=n.height}return n(e,[{key:"createFrame",value:function(){var t=this.context2d.createImageData(this.width,this.height);return new r(t)}},{key:"drawFrame",value:function(t){this.context2d.putImageData(t.image,0,0)}}]),e}(),o=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t(this,e),this.x=n,this.y=r,this.z=i}return n(e,[{key:"isValid",value:function(){return!Number.isNaN(this.x)&&!Number.isNaN(this.y)&&!Number.isNaN(this.z)}},{key:"set",value:function(t){this.x=t.x,this.y=t.y,this.z=t.z}},{key:"copy",value:function(){return new e(this.x,this.y,this.z)}},{key:"getLength",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"getLengthSquare",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"dotProduct",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"crossProduct",value:function(t){var e=this.y*t.z-this.z*t.y,n=this.z*t.x-this.x*t.z,r=this.x*t.y-this.y*t.x;this.x=e,this.y=n,this.z=r}},{key:"add",value:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z}},{key:"substract",value:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z}},{key:"multiply",value:function(t){this.x*=t.x,this.y*=t.y,this.z*=t.z}},{key:"divide",value:function(t){this.x/=t.x,this.y/=t.y,this.z/=t.z}},{key:"multiplyByScalar",value:function(t){this.x*=t,this.y*=t,this.z*=t}},{key:"divideByScalar",value:function(t){this.x/=t,this.y/=t,this.z/=t}},{key:"addScaled",value:function(t,e){this.x+=e*t.x,this.y+=e*t.y,this.z+=e*t.z}},{key:"substractScaled",value:function(t,e){this.x-=e*t.x,this.y-=e*t.y,this.z-=e*t.z}},{key:"normalize",value:function(){var t=this.getLength();0!==t&&this.divideByScalar(t)}},{key:"reflect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=2*this.dotProduct(t)*e;this.substractScaled(t,n)}},{key:"rotateAroundX",value:function(t){if(0!==t){var e=this.y,n=this.z;this.y=e*Math.cos(t)-n*Math.sin(t),this.z=e*Math.sin(t)+n*Math.cos(t)}}},{key:"rotateAroundY",value:function(t){if(0!==t){var e=this.x,n=this.z;this.x=e*Math.cos(t)+n*Math.sin(t),this.z=-e*Math.sin(t)+n*Math.cos(t)}}},{key:"rotateAroundZ",value:function(t){if(0!==t){var e=this.x,n=this.y;this.x=e*Math.cos(t)-n*Math.sin(t),this.y=e*Math.sin(t)+n*Math.cos(t)}}}]),e}();function a(t,e){return(a=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&a(t,e)}function c(t){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function u(t,e){return!e||"object"!==c(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var h=function(){function e(n,r,i,a,s){t(this,e),this.pos=new o(n,r,i),this.force=new o(0,0,0),this.velocity=new o(0,0,0),this.m=s,this.charge=a,this.r=0,this.drawPath=!1,this.path=[],this.color={r:255,g:255,b:255},this.removed=!1}return n(e,[{key:"remove",value:function(){this.removed=!0}},{key:"setMass",value:function(t){this.m=t}},{key:"resetForce",value:function(){this.force.multiplyByScalar(0)}},{key:"attract",value:function(t){return Math.sign(this.charge)!==Math.sign(t.charge)}},{key:"distanceTo",value:function(t){var e=Math.abs(this.pos.x-t.pos.x),n=Math.abs(this.pos.y-t.pos.y),r=Math.abs(this.pos.z-t.pos.z);return new o(e,n,r)}},{key:"orientationTo",value:function(t){var e=this.pos.x<t.pos.x?1:-1,n=this.pos.y<t.pos.y?1:-1,r=this.pos.z<t.pos.z?1:-1;return new o(e,n,r)}},{key:"resetPath",value:function(){this.path=[]}},{key:"setPos",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];(e||this.drawPath)&&this.path.push(this.pos.copy()),this.pos.set(t)}}]),e}();var f=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(){return t(this,o),i.apply(this,arguments)}return o}(h);var y=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(e,n,r){var a;return t(this,o),(a=i.call(this,e,n,r,1,938)).color={r:255,g:136,b:136},a}return o}(f);var v=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(e,n,r){var a;return t(this,o),(a=i.call(this,e,n,r,-1,.5)).color={r:136,g:136,b:255},a}return o}(f);function d(t,e,n){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=l(t)););return t}(t,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(n):i.value}})(t,e,n||t)}var p=function(e){s(a,e);var r,i,o=(r=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(r);if(i){var n=l(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function a(e,n,r){var i,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5e5;return t(this,a),(i=o.call(this,e,n,r,0,s)).r=Math.log(s),i.color=i.getColor(s),i}return n(a,[{key:"getColor",value:function(t){var e=Math.log(t);return t>=1e9?{r:255-Math.round(e),g:255-Math.round(e/2),b:255}:{r:255,g:Math.round(10*e),b:0}}},{key:"setMass",value:function(t){d(l(a.prototype),"setMass",this).call(this,t),this.color=this.getColor(t)}}]),a}(h);var m=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(e,n,r){var a,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return t(this,o),(a=i.call(this,e,n,r,0,s)).color={r:136,g:136,b:136},a}return o}(h);var g=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(e,n,r){var a;return t(this,o),(a=i.call(this,e,n,r,0,1e7)).color={r:0,g:0,b:0},a}return o}(h);function x(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var w=["x","y","z"];function b(t,e,n,r){var i=r.copy(),o=e.dotProduct(i);if(Math.abs(o)<1e-8)return null;var a=(e.dotProduct(t)-e.dotProduct(n))/o,s=n.copy();return s.addScaled(i,a),s}function z(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=Math.min(t,e),r=Math.max(t,e),i=Math.abs(r-n);return 0===i?n:Math.random()*i+n}function S(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return k(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?k(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function k(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var P=function(){function e(n,r,i){t(this,e);var a=n/2,s=r/2,c=i/2;this.halfSize=new o(a,s,c),this.vertices=[new o(-a,s,-c),new o(a,s,-c),new o(a,s,c),new o(-a,s,c),new o(-a,-s,-c),new o(a,-s,-c),new o(a,-s,c),new o(-a,-s,c)],this.edges=[[0,1],[1,2],[2,3],[3,0],[0,4],[1,5],[2,6],[3,7],[4,5],[5,6],[6,7],[7,4]],this.normals={x:new o(1,0,0),y:new o(0,1,0),z:new o(0,0,1)},this.planePoints={x:{left:1,right:0},y:{left:0,right:4},z:{left:3,right:0}}}return n(e,[{key:"getPlanePoint",value:function(t,e){var n=this.normals[t],r=e.dotProduct(n);if(0===r)return null;var i=this.planePoints[t];return this.vertices[r>0?i.left:i.right]}},{key:"rotate",value:function(t,e,n){var r,i=S(this.vertices);try{for(i.s();!(r=i.n()).done;){var o=r.value;o.rotateAroundX(t),o.rotateAroundY(e),o.rotateAroundZ(n)}}catch(t){i.e(t)}finally{i.f()}var a,s=S(w);try{for(s.s();!(a=s.n()).done;){var c=a.value,u=this.normals[c];u.rotateAroundX(t),u.rotateAroundY(e),u.rotateAroundZ(n)}}catch(t){s.e(t)}finally{s.f()}}},{key:"getIntersectPoint",value:function(t,e){var n=-t.z/(e.z-t.z),r=n*(e.x-t.x)+t.x,i=n*(e.y-t.y)+t.y;return new o(r,i,0)}},{key:"draw",value:function(t,e,n,r){var i,o=0,a=S(this.vertices);try{for(a.s();!(i=a.n()).done;){var s=i.value.copy();s.add(e),o=Math.max(o,s.z)}}catch(t){a.e(t)}finally{a.f()}var c,u=S(this.edges);try{for(u.s();!(c=u.n()).done;){var l=c.value,h=this.vertices[l[0]].copy();h.add(e);var f=this.vertices[l[1]].copy();if(f.add(e),!(h.z<0&&f.z<0)){if(h.z<0||f.z<0){var y=this.getIntersectPoint(h,f);h.z<0?h=y:f=y}var v=(h.z+f.z)/2,d=Math.round(255*(1-v/o)),p=n(h),m=r(h),g=n(f),x=r(f);t.drawLine(p,m,g,x,d,d,d,255)}}}catch(t){u.e(t)}finally{u.f()}}},{key:"getIntersection",value:function(t,e){var n={},r=[],i=e.copy();if(i.substract(t),0===i.x&&0===i.y&&0===i.z)return null;var o,a=S(w);try{for(a.s();!(o=a.n()).done;){var s=o.value;n[s]=e.dotProduct(this.normals[s]);var c=Math.abs(n[s])-this.halfSize[s];c>0&&r.push({axis:s,out:c})}}catch(m){a.e(m)}finally{a.f()}if(!r.length)return null;r.length>1&&r.sort((function(t,e){return t.out-e.out}));for(var u,l,h=!1,f=[];r.length>0&&!h;){var y=r.pop(),v=this.getPlanePoint(y.axis,i);if(v&&(l=b(v,u=this.normals[y.axis],t,e)))for(var d in h=!0,this.normals)if(d!==y.axis){var p=l.dotProduct(this.normals[d]),m=Math.abs(p)-this.halfSize[d];if(m>1e-8){f.push({point:l.copy(),normal:u,error:m}),h=!1;break}}}if(h)f.push({point:l,normal:u});else{if(!f.length)throw new Error("Intersections not found");f.length>0&&f.sort((function(t,e){return t.error-e.error}))}return f[0]}}]),e}();var M=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(e,n,r){var a;return t(this,o),(a=i.call(this,e,n,r,0,0)).color={r:255,g:255,b:0},a.drawPath=!1,a}return o}(f);var F=function(e){s(o,e);var n,r,i=(n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=l(n);if(r){var i=l(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return u(this,t)});function o(e,n,r){var a;return t(this,o),(a=i.call(this,e,n,r,-1,.5)).color={r:255,g:51,b:51},a}return o}(f);function I(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return R(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?R(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function R(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var B=function(){function e(n,r,i){if(t(this,e),!n)throw new Error("Invalid canvas");this.canvas=n,this.depth=2e3,this.xShift=0,this.yShift=0,this.width=this.canvas.width,this.height=this.canvas.height,this.DIST=1e3,this.Z_SHIFT=0,this.drawAllPaths=!1,this.useCollide=!0,this.restoreCollided=!0,this.useSoftening=!1,this.SOFTENING=2,this.addInstantly=!0,this.newParticles=[],this.rotation={alpha:0,beta:0,gamma:0},this.box=new P(this.width,this.height,this.depth),this.center=new o(this.width/2,this.height/2,this.depth/2),this.particles=[],this.setScaleFactor(r),this.setTimeStep(i)}return n(e,[{key:"drawFrameByCircles",value:function(){this.canvas.context2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.context2d.fillStyle="white",this.canvas.context2d.strokeStyle="white",this.canvas.context2d.lineWidth=1;var t,e=I(this.particles);try{for(e.s();!(t=e.n()).done;){var n=t.value;this.canvas.context2d.fillStyle="rgb(".concat(n.color.r,", ").concat(n.color.g,", ").concat(n.color.b,")"),this.canvas.context2d.strokeStyle="rgb(".concat(n.color.r,", ").concat(n.color.g,", ").concat(n.color.b,")"),this.canvas.context2d.beginPath(),this.canvas.context2d.arc(this.xF(n.pos),this.yF(n.pos),.5,0,2*Math.PI,!0),this.canvas.context2d.stroke()}}catch(t){e.e(t)}finally{e.f()}}},{key:"yF",value:function(t){return this.center.y-this.DIST*(this.center.y-t.y)/(this.DIST+t.z+this.Z_SHIFT)}},{key:"xF",value:function(t){return this.center.x-this.DIST*(this.center.x-t.x)/(this.DIST+t.z+this.Z_SHIFT)}},{key:"rotateVector",value:function(t,e,n,r){t.rotateAroundX(e),t.rotateAroundY(n),t.rotateAroundZ(r)}},{key:"rotate",value:function(t,e,n){this.box.rotate(t,e,n);var r,i=I(this.particles);try{for(i.s();!(r=i.n()).done;){var o=r.value;this.rotateVector(o.pos,t,e,n),this.rotateVector(o.velocity,t,e,n),this.rotateVector(o.force,t,e,n)}}catch(t){i.e(t)}finally{i.f()}this.rotation.alpha+=t,this.rotation.beta+=e,this.rotation.gamma+=n}},{key:"drawParticlePath",value:function(t,e){var n=new o;n.set(e.pos),n.add(this.center);for(var r=this.xF(n),i=this.yF(n);e.path.length>0;){var a=e.path.pop();n.set(a),n.add(this.center);var s=this.xF(n),c=this.yF(n);t.drawLine(s,c,r,i,e.color.r,e.color.g,e.color.b,255),r=s,i=c}}},{key:"drawFrameByPixels",value:function(){var t=this,e=this.canvas.createFrame();this.box.draw(e,this.center,(function(e){return t.xF(e)}),(function(e){return t.yF(e)})),this.particles.sort((function(t,e){return e.pos.z-t.pos.z}));var n,r=new o,i=I(this.particles);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(!(a instanceof g)){r.set(a.pos),r.add(this.center);var s=this.xF(r),c=this.yF(r);e.putPixel(s,c,a.color.r,a.color.g,a.color.b,Math.round(this.depth/r.z*255)),(this.drawAllPaths||a.drawPath)&&this.drawParticlePath(e,a)}}}catch(t){i.e(t)}finally{i.f()}this.canvas.drawFrame(e)}},{key:"drawFrame",value:function(){this.drawFrameByPixels()}},{key:"setScaleFactor",value:function(t){this.scaleFactor=t,this.maxVelocity=t<1?50:50/t,this.minDistance=.05/t}},{key:"setTimeStep",value:function(t){this.timeStep=t}},{key:"add",value:function(t){t instanceof h&&(this.addInstantly?this.particles.push(t):this.newParticles.push(t))}},{key:"push",value:function(t){t instanceof h&&this.particles.push(t)}},{key:"force",value:function(t,e){if(!t.removed)for(var n=t.force,r=e+1,i=this.particles.length;r<i;r+=1){var o=this.particles[r];if(!o.removed){var a=o.force,s=t.distanceTo(o),c=t.orientationTo(o),u=s.getLength()*this.scaleFactor;this.useCollide||(u=Math.max(u,this.minDistance)),s.divideByScalar(u),s.multiply(c);var l=s.copy();l.multiplyByScalar(-1);var h=u*u;if(this.useCollide&&u-(t.r+o.r)/(2*this.scaleFactor)<.05/this.scaleFactor){var f=this.collide(t,o);if(t.removed)return;if(f)continue}if(t.charge&&o.charge){var y=89*(t.attract(o)?1:-1)*Math.abs(t.charge*o.charge)/h;n.addScaled(s,y),a.addScaled(l,y)}var v=this.useSoftening?h*Math.sqrt(h+this.SOFTENING):h,d=6670000000000001e-20*Math.abs(t.m*o.m)/v;n.addScaled(s,d),a.addScaled(l,d)}}}},{key:"resolveMassive",value:function(t,e){var n=t.m>e.m?t:e,r=t.m>e.m?t:e,i=t.m+e.m,o=i>=1e5?p:m;if(n instanceof o)n.setMass(i);else{var a=new o(n.pos.x,n.pos.y,n.pos.z,i);n.remove(),n=a}var s=r.m/i;return n.velocity.addScaled(r.velocity,s),this.fixVelocity(n),r.remove(),this.restoreCollided&&this.addNew(),!0}},{key:"getOrthogonalTo",value:function(t){var e=t.x<t.y&&t.x<t.z?1:0,n=t.y<=t.x&&t.y<t.z?1:0,r=t.z<=t.x&&t.z<=t.y?1:0,i=t.copy();return i.crossProduct(new o(e,n,r)),i}},{key:"resolveQuants",value:function(t,e){var n=t instanceof M,r=e instanceof M;if(n&&r)return!1;if(n&&!r||!n&&r){var i=n?t:e,o=n?e:t;o.velocity.add(i.velocity),this.fixVelocity(o),i.remove()}if(!n&&!r){var a=t instanceof v,s=e instanceof v,c=t.pos.copy();if(c.substract(e.pos),(a||s)&&(t instanceof F||e instanceof F)){var u=new M(t.pos.x,t.pos.y,t.pos.z),l=this.getOrthogonalTo(c);l.normalize(),l.multiplyByScalar(this.maxVelocity),u.velocity.set(l),this.add(u);var h=new M(t.pos.x,t.pos.y,t.pos.z);h.velocity.set(u.velocity),h.velocity.multiplyByScalar(-1),this.add(h),t.remove(),e.remove()}else if(a||s){var f=new M(t.pos.x,t.pos.y,t.pos.z);f.velocity.set(c),this.add(f)}}return!1}},{key:"collide",value:function(t,e){return!(t instanceof g||e instanceof g)&&(t instanceof f||e instanceof f?t instanceof f&&e instanceof f?this.resolveQuants(t,e):void 0:this.resolveMassive(t,e))}},{key:"spontaneous",value:function(){if(!(z()<.2)){var t=new o(z(-this.center.x,this.center.x),z(-this.center.y,this.center.y),z(-this.center.z,this.center.z));this.rotateVector(t,this.rotation.alpha,this.rotation.beta,this.rotation.gamma);var e=new v(t.x,t.y,t.z);e.velocity.x=z(0,this.maxVelocity),e.velocity.y=z(0,this.maxVelocity),e.velocity.z=z(0,this.maxVelocity),this.fixVelocity(e),this.add(e);var n=new F(t.x,t.y,t.z);n.velocity.set(e.velocity),n.velocity.multiplyByScalar(-1),this.add(n)}}},{key:"addNew",value:function(){var t=new o(z(-this.center.x,this.center.x),z(-this.center.y,this.center.y),z(-this.center.z,this.center.z));this.rotateVector(t,this.rotation.alpha,this.rotation.beta,this.rotation.gamma),this.add(new p(t.x,t.y,t.z,z(1e5,1e6)))}},{key:"relVelocity",value:function(t){return this.maxVelocity*Math.tanh(t/this.maxVelocity)}},{key:"borderCondition",value:function(t){var e=t.velocity.copy(),n=new o,r=new o;for((this.drawAllPaths||t.drawPath)&&t.resetPath();;){n.set(t.pos),r.set(n),r.add(e);var i=this.box.getIntersection(n,r);if(!i)return n.add(e),void t.setPos(n,this.drawAllPaths);if(t.setPos(i.point,this.drawAllPaths),e.set(r),e.substract(i.point),e.reflect(i.normal),e.multiplyByScalar(.1),t.velocity.reflect(i.normal),t.velocity.multiplyByScalar(.1),!e.getLength())break}}},{key:"applyForce",value:function(t){var e=t.velocity,n=t.force;if(0===t.m)e.add(n),e.normalize(),e.multiplyByScalar(this.maxVelocity);else{var r=this.timeStep/t.m;e.addScaled(n,r),this.fixVelocity(t)}this.borderCondition(t)}},{key:"fixVelocity",value:function(t){var e=t.velocity.getLength(),n=this.relVelocity(e);if(n<e){var r=n/e;t.velocity.multiplyByScalar(r)}}},{key:"calculate",value:function(){var t,e,n=this;this.addInstantly||(this.newParticles=[]),this.particles.forEach((function(t){return t.resetForce()})),this.particles.forEach((function(t,e){return n.force(t,e)})),this.particles=this.particles.filter((function(t){return!t.removed})),this.addInstantly||(t=this.particles).push.apply(t,function(t){if(Array.isArray(t))return x(t)}(e=this.newParticles)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(e)||function(t,e){if(t){if("string"==typeof t)return x(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?x(t,e):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.spontaneous(),this.particles.forEach((function(t){return n.applyForce(t)}))}}]),e}(),A=.01,E=null,O=null,T=null,C=null,V=0,j=null,L=null,N=null,D=null,_=!0,Z=!1,H=!1,X={alpha:0,beta:0,gamma:0},Y=null;function q(){var t=Y.scaleFactor.toFixed(3),e=parseFloat(t);E.textContent=t,O.value=e,T.textContent=Y.particles.length,C.textContent=V,D.textContent=_?"Run":"Pause",j.textContent=X.alpha.toFixed(2),L.textContent=X.beta.toFixed(2),N.textContent=X.gamma.toFixed(2)}function U(){if(!H&&!_){Z=!0;var t=performance.now();Y.calculate(),Y.drawFrame(),0!==A&&Y.setScaleFactor(Y.scaleFactor+A),V=Math.round(performance.now()-t),q(),_||setTimeout(U,10),Z=!1}}function $(){Y.setScaleFactor(1e-4),Y.setTimeStep(.1),Y.addInstantly=!0,A=0;for(var t=0;t<50;t+=1){var e=z(),n=z(-Y.center.x,Y.center.x),r=z(-Y.center.y,Y.center.y),i=z(-Y.center.z,Y.center.z),o=void 0;(o=e>.5?new y(n,r,i):new v(n,r,i)).velocity.x=z(-.1,.1),o.velocity.y=z(-.1,.1),o.velocity.z=z(-.1,.1),Y.push(o)}}function G(){_||(_=!0,q())}function Q(){_&&(_=!1,q(),setTimeout(U,10))}function W(t){var e=parseFloat(t.target.value);Y.setScaleFactor(e),q()}function J(t,e,n,r){H=!0,Z&&setTimeout((function(){return J(t,e,n,r)}),10),Y.rotate(t,e,n),Y.drawFrame(),r?q():Q(),H=!1}function K(t){var e=_;G();var n=parseFloat(t.target.value),r=n-X.alpha;X.alpha=n,J(r,0,0,e)}function tt(t){var e=_;G();var n=parseFloat(t.target.value),r=n-X.beta;X.beta=n,J(0,r,0,e)}function et(t){var e=_;G();var n=parseFloat(t.target.value),r=n-X.gamma;X.gamma=n,J(0,0,r,e)}function nt(){_?Q():G()}document.addEventListener("DOMContentLoaded",(function(){var t=new i(document.getElementById("cnv"));(O=document.getElementById("scaleFactorInp")).addEventListener("input",W),E=document.getElementById("scalefactor"),T=document.getElementById("particlescount"),C=document.getElementById("perfvalue"),document.getElementById("xRotationInp").addEventListener("input",K),j=document.getElementById("xrotate"),document.getElementById("yRotationInp").addEventListener("input",tt),L=document.getElementById("yrotate"),document.getElementById("zRotationInp").addEventListener("input",et),N=document.getElementById("zrotate"),(D=document.getElementById("toggleRunBtn")).addEventListener("click",nt);var e=$;Y=new B(t,.1,.1),e(),Y.drawFrame(),q()}))})();